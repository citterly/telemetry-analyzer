{% extends "base.html" %}

{% block title %}Analysis Results - {{ super() }}{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analysis-card {
        background-color: #353535;
        border-left: 4px solid #4a90e2;
        margin-bottom: 1rem;
    }
    .analysis-card.shifts { border-left-color: #e17055; }
    .analysis-card.laps { border-left-color: #00b894; }
    .analysis-card.gears { border-left-color: #6c5ce7; }
    .analysis-card.power { border-left-color: #fdcb6e; }

    .metric-box {
        background: linear-gradient(135deg, #4a90e2 0%, #6c5ce7 100%);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        color: white;
    }
    .metric-box.success { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); }
    .metric-box.warning { background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%); }
    .metric-box.info { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }

    .metric-value { font-size: 1.8rem; font-weight: bold; }
    .metric-label { font-size: 0.85rem; opacity: 0.9; }

    .shift-quality-early { color: #fdcb6e; }
    .shift-quality-optimal { color: #00b894; }
    .shift-quality-late { color: #e17055; }
    .shift-quality-over-rev { color: #d63031; }

    .recommendation-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: rgba(116, 185, 255, 0.1);
        border-left: 3px solid #74b9ff;
        border-radius: 0 4px 4px 0;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .chart-container {
        position: relative;
        height: 250px;
        margin-bottom: 1rem;
    }

    /* Lap classification badges */
    .badge-hot-lap { background-color: #00b894; }
    .badge-race-pace { background-color: #0984e3; }
    .badge-warm-up { background-color: #fdcb6e; color: #2d2d2d; }
    .badge-cool-down { background-color: #636e72; }
    .badge-out-lap { background-color: #a29bfe; }

    /* Lap filter buttons */
    .lap-filter-group .btn-check:checked + .btn-outline-success {
        background-color: #00b894; border-color: #00b894; color: white;
    }
    .lap-filter-group .btn-check:checked + .btn-outline-primary {
        background-color: #0984e3; border-color: #0984e3; color: white;
    }
    .lap-filter-group .btn-check:checked + .btn-outline-warning {
        background-color: #fdcb6e; border-color: #fdcb6e; color: #2d2d2d;
    }
    .lap-filter-group .btn-check:checked + .btn-outline-secondary {
        background-color: #636e72; border-color: #636e72; color: white;
    }

    /* Track map styling */
    #track-map-container svg {
        max-width: 100%;
        height: auto;
    }

    /* Lap recommendations */
    .lap-recommendation {
        background: rgba(0, 184, 148, 0.1);
        border-left: 4px solid #00b894;
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    .recommended-lap-badge {
        display: inline-block;
        background: #00b894;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-right: 0.25rem;
        font-weight: bold;
    }

    /* Hidden lap rows when filtered */
    tr.lap-hidden { display: none; }

    /* Lap selection */
    .lap-checkbox { width: 18px; height: 18px; cursor: pointer; }
    .lap-selected { background-color: rgba(0, 184, 148, 0.15) !important; }

    /* Comparison view */
    .comparison-section { display: none; }
    .delta-positive { color: #00b894; }
    .delta-negative { color: #e74c3c; }
    .delta-neutral { color: #636e72; }
    .segment-bar {
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        border-radius: 3px;
    }
    .segment-a { background-color: rgba(0, 184, 148, 0.7); }
    .segment-b { background-color: rgba(231, 76, 60, 0.7); }
    .segment-equal { background-color: rgba(99, 110, 114, 0.5); }

    /* Delta track map */
    #delta-track-map-container {
        background: #16213e;
        border-radius: 8px;
        padding: 10px;
    }
    #delta-track-map-container svg {
        max-width: 100%;
        height: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Session Analysis</h1>
        <p class="text-muted">Run telemetry analysis on extracted session data</p>
    </div>
</div>

<!-- File Selection -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">Select Session</div>
            <div class="card-body">
                <select class="form-select" id="file-select" onchange="updateAnalysisButtons()">
                    <option value="">Loading sessions...</option>
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Analysis Type</div>
            <div class="card-body">
                <div class="btn-group-vertical w-100" id="analysis-buttons">
                    <button class="btn btn-outline-primary" onclick="runAnalysis('report')" id="btn-report" disabled>
                        Full Report
                    </button>
                    <button class="btn btn-outline-info" onclick="runAnalysis('shifts')" id="btn-shifts" disabled>
                        Shift Analysis
                    </button>
                    <button class="btn btn-outline-info" onclick="runAnalysis('laps')" id="btn-laps" disabled>
                        Lap Analysis
                    </button>
                    <button class="btn btn-outline-info" onclick="runAnalysis('gears')" id="btn-gears" disabled>
                        Gear Usage
                    </button>
                    <button class="btn btn-outline-info" onclick="runAnalysis('power')" id="btn-power" disabled>
                        Power Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Track Map Section -->
<div class="card mb-4" id="track-map-section" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><strong>Track Map</strong></span>
        <select id="track-map-color" class="form-select form-select-sm" style="width: 150px;">
            <option value="speed">Speed</option>
            <option value="rpm">RPM</option>
            <option value="gear">Gear</option>
        </select>
    </div>
    <div class="card-body">
        <!-- Threshold Sliders -->
        <div class="row mb-3" id="threshold-controls">
            <div class="col-md-6">
                <label for="low-threshold" class="form-label d-flex justify-content-between">
                    <span><span class="badge" style="background:#2ecc71;">Green</span> threshold</span>
                    <span id="low-threshold-value">33%</span>
                </label>
                <input type="range" class="form-range" id="low-threshold" min="10" max="50" value="33">
            </div>
            <div class="col-md-6">
                <label for="high-threshold" class="form-label d-flex justify-content-between">
                    <span><span class="badge" style="background:#e74c3c;">Red</span> threshold</span>
                    <span id="high-threshold-value">66%</span>
                </label>
                <input type="range" class="form-range" id="high-threshold" min="50" max="90" value="66">
            </div>
        </div>
        <!-- Track Map SVG Container -->
        <div class="text-center" id="track-map-container">
            <div class="text-muted">Loading track map...</div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-white">Running analysis...</p>
    </div>
</div>

<!-- Results Section -->
<div id="results-section" style="display: none;">

    <!-- Lap Recommendations Panel -->
    <div id="lap-recommendations" class="lap-recommendation" style="display: none;">
        <strong>Recommended Laps:</strong> <span id="recommended-laps"></span>
        <br><small id="recommendation-reason" class="text-muted"></small>
    </div>

    <!-- Lap Filter Buttons -->
    <div id="lap-filter-section" class="mb-3" style="display: none;">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="btn-group btn-group-sm lap-filter-group" role="group">
                <input type="checkbox" class="btn-check" id="filter-hot" checked autocomplete="off">
                <label class="btn btn-outline-success" for="filter-hot">Hot Laps</label>

                <input type="checkbox" class="btn-check" id="filter-race" checked autocomplete="off">
                <label class="btn btn-outline-primary" for="filter-race">Race Pace</label>

                <input type="checkbox" class="btn-check" id="filter-warmup" autocomplete="off">
                <label class="btn btn-outline-warning" for="filter-warmup">Warm-up</label>

                <input type="checkbox" class="btn-check" id="filter-cooldown" autocomplete="off">
                <label class="btn btn-outline-secondary" for="filter-cooldown">Cool-down</label>

                <input type="checkbox" class="btn-check" id="filter-outlap" autocomplete="off">
                <label class="btn btn-outline-info" for="filter-outlap">Out Laps</label>
            </div>
            <button class="btn btn-sm btn-success" id="compare-laps-btn" style="display: none;" onclick="compareLaps()">
                Compare Selected (<span id="selected-count">0</span>)
            </button>
        </div>
    </div>

    <!-- Lap Comparison Section -->
    <div id="lap-comparison-section" class="comparison-section mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Lap Comparison: <span id="comparison-title">Lap X vs Lap Y</span></strong>
                <button class="btn btn-sm btn-outline-secondary" onclick="hideComparison()">Close</button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-dark">
                            <div class="card-body text-center">
                                <h5 id="comp-lap-a-label">Lap A</h5>
                                <div class="h3" id="comp-lap-a-time">--</div>
                                <small class="text-muted">Avg: <span id="comp-lap-a-avg">--</span> mph | Max: <span id="comp-lap-a-max">--</span> mph</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-dark">
                            <div class="card-body text-center">
                                <h5 id="comp-lap-b-label">Lap B</h5>
                                <div class="h3" id="comp-lap-b-time">--</div>
                                <small class="text-muted">Avg: <span id="comp-lap-b-avg">--</span> mph | Max: <span id="comp-lap-b-max">--</span> mph</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="text-center mb-2">
                            <span id="comp-delta-summary" class="h4">--</span>
                        </div>
                    </div>
                </div>
                <!-- Delta Track Map -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h6>Delta Track Map <small class="text-muted">(Green = Lap A faster, Red = Lap B faster)</small></h6>
                        <div id="delta-track-map-container" class="text-center" style="min-height: 300px;">
                            <div class="text-muted">Loading delta track map...</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <h6>Speed Delta (Lap A - Lap B)</h6>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="speed-delta-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Segment Analysis</h6>
                        <div id="segment-bars" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Row -->
    <div class="row mb-4" id="summary-row">
        <!-- Filled by JS -->
    </div>

    <!-- Recommendations -->
    <div class="row mb-4" id="recommendations-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">Recommendations</div>
                <div class="card-body" id="recommendations-content">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Results -->
    <div class="row" id="details-section">
        <!-- Filled by JS based on analysis type -->
    </div>

</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentAnalysisType = null;
    let currentData = null;
    let charts = {};

    // Load file list on page load
    document.addEventListener('DOMContentLoaded', loadFileList);

    async function loadFileList() {
        try {
            const response = await fetch('/api/parquet/list');
            const data = await response.json();

            const select = document.getElementById('file-select');
            select.innerHTML = '<option value="">Select a session...</option>';

            for (const file of data.parquet_files) {
                if (!file.error) {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = `${file.filename} (${file.rows.toLocaleString()} rows, ${file.columns} channels)`;
                    select.appendChild(option);
                }
            }
        } catch (error) {
            showAlert('Failed to load session list: ' + error.message, 'danger');
        }
    }

    function updateAnalysisButtons() {
        const hasFile = document.getElementById('file-select').value !== '';
        document.querySelectorAll('#analysis-buttons button').forEach(btn => {
            btn.disabled = !hasFile;
        });
    }

    async function runAnalysis(type) {
        const filename = document.getElementById('file-select').value;
        if (!filename) {
            showAlert('Please select a session first', 'warning');
            return;
        }

        currentAnalysisType = type;
        currentFile = filename;
        document.getElementById('loading').style.display = 'flex';

        // Destroy existing charts
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};

        // Hide previous UI elements
        document.getElementById('lap-filter-section').style.display = 'none';
        document.getElementById('lap-recommendations').style.display = 'none';
        document.getElementById('track-map-section').style.display = 'none';

        try {
            const response = await fetch(`/api/analyze/${type}/${encodeURIComponent(filename)}`);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Analysis failed');
            }

            currentData = await response.json();
            displayResults(type, currentData);

            // Load track map for lap analysis
            if (type === 'laps' || type === 'report') {
                loadTrackMap(filename, document.getElementById('track-map-color').value);
            }

        } catch (error) {
            showAlert('Analysis failed: ' + error.message, 'danger');
            document.getElementById('results-section').style.display = 'none';
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function displayResults(type, data) {
        document.getElementById('results-section').style.display = 'block';

        switch (type) {
            case 'report':
                displayFullReport(data);
                break;
            case 'shifts':
                displayShiftAnalysis(data);
                break;
            case 'laps':
                displayLapAnalysis(data);
                break;
            case 'gears':
                displayGearAnalysis(data);
                break;
            case 'power':
                displayPowerAnalysis(data);
                break;
        }
    }

    function displayFullReport(data) {
        // Summary metrics
        const summary = data.summary;
        document.getElementById('summary-row').innerHTML = `
            <div class="col-md-3 mb-3">
                <div class="metric-box success">
                    <div class="metric-value">${formatLapTime(summary.fastest_lap.lap_time)}</div>
                    <div class="metric-label">Fastest Lap (Lap ${summary.fastest_lap.lap_number})</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box info">
                    <div class="metric-value">${summary.total_laps}</div>
                    <div class="metric-label">Total Laps</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box">
                    <div class="metric-value">${summary.max_speed_mph.toFixed(0)} mph</div>
                    <div class="metric-label">Max Speed</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box warning">
                    <div class="metric-value">${summary.total_shifts}</div>
                    <div class="metric-label">Total Shifts</div>
                </div>
            </div>
        `;

        // Recommendations
        displayRecommendations(data.combined_recommendations);

        // Detailed sections
        let detailsHtml = '';

        // Lap times chart
        if (data.lap_analysis && data.lap_analysis.laps && data.lap_analysis.laps.length > 0) {
            detailsHtml += `
                <div class="col-md-6 mb-4">
                    <div class="card analysis-card laps">
                        <div class="card-header">Lap Times</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="lap-times-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Shift distribution
        if (data.shift_analysis && data.shift_analysis.gear_stats) {
            detailsHtml += `
                <div class="col-md-6 mb-4">
                    <div class="card analysis-card shifts">
                        <div class="card-header">Shift RPM by Gear</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="shift-rpm-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Metadata
        detailsHtml += `
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">Session Information</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4"><strong>Session:</strong> ${data.metadata.session_id}</div>
                            <div class="col-md-4"><strong>Track:</strong> ${data.metadata.track_name}</div>
                            <div class="col-md-4"><strong>Duration:</strong> ${(data.metadata.total_duration_seconds / 60).toFixed(1)} minutes</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('details-section').innerHTML = detailsHtml;

        // Render charts after DOM update
        setTimeout(() => {
            if (data.lap_analysis && data.lap_analysis.laps) {
                renderLapTimesChart(data.lap_analysis.laps);
            }
            if (data.shift_analysis && data.shift_analysis.gear_stats) {
                renderShiftRpmChart(data.shift_analysis.gear_stats);
            }
        }, 100);
    }

    function displayShiftAnalysis(data) {
        // Summary
        document.getElementById('summary-row').innerHTML = `
            <div class="col-md-3 mb-3">
                <div class="metric-box">
                    <div class="metric-value">${data.total_shifts}</div>
                    <div class="metric-label">Total Shifts</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box info">
                    <div class="metric-value">${data.total_upshifts}</div>
                    <div class="metric-label">Upshifts</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box success">
                    <div class="metric-value">${data.total_shifts - data.early_shifts - data.late_shifts - data.over_rev_shifts}</div>
                    <div class="metric-label">Optimal Shifts</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box warning">
                    <div class="metric-value">${data.early_shifts + data.late_shifts}</div>
                    <div class="metric-label">Suboptimal Shifts</div>
                </div>
            </div>
        `;

        displayRecommendations(data.recommendations);

        // Shift details
        let detailsHtml = `
            <div class="col-md-6 mb-4">
                <div class="card analysis-card shifts">
                    <div class="card-header">Shift RPM by Gear</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="shift-rpm-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card analysis-card shifts">
                    <div class="card-header">Gear Statistics</div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr><th>Gear</th><th>Upshifts</th><th>Avg RPM</th><th>Target</th></tr>
                            </thead>
                            <tbody>
        `;

        for (const [gear, stats] of Object.entries(data.gear_stats)) {
            if (stats.upshift_count > 0) {
                detailsHtml += `
                    <tr>
                        <td><strong>Gear ${gear}</strong></td>
                        <td>${stats.upshift_count}</td>
                        <td>${stats.avg_upshift_rpm.toFixed(0)} RPM</td>
                        <td>${stats.optimal_upshift_rpm} RPM</td>
                    </tr>
                `;
            }
        }

        detailsHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">Recent Shifts</div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Gear</th>
                                    <th>RPM</th>
                                    <th>Speed</th>
                                    <th>Quality</th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        const recentShifts = data.shifts.slice(-50);
        for (const shift of recentShifts) {
            const qualityClass = `shift-quality-${shift.shift_quality.replace('_', '-')}`;
            detailsHtml += `
                <tr>
                    <td>${shift.time.toFixed(1)}s</td>
                    <td>${shift.shift_type}</td>
                    <td>${shift.from_gear} â†’ ${shift.to_gear}</td>
                    <td>${shift.rpm_at_shift.toFixed(0)}</td>
                    <td>${shift.speed_mph.toFixed(0)} mph</td>
                    <td class="${qualityClass}">${shift.shift_quality}</td>
                </tr>
            `;
        }

        detailsHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('details-section').innerHTML = detailsHtml;

        setTimeout(() => {
            renderShiftRpmChart(data.gear_stats);
        }, 100);
    }

    function displayLapAnalysis(data) {
        const fastest = data.fastest_lap || {};

        // Count laps by classification
        const hotLaps = (data.laps || []).filter(l => l.classification === 'hot_lap').length;
        const consistencyPct = data.lap_time_consistency !== undefined
            ? (100 - (data.lap_time_consistency / data.average_lap_time * 100)).toFixed(1)
            : 'N/A';

        document.getElementById('summary-row').innerHTML = `
            <div class="col-md-3 mb-3">
                <div class="metric-box success">
                    <div class="metric-value">${formatLapTime(fastest.lap_time)}</div>
                    <div class="metric-label">Fastest Lap (Lap ${fastest.lap_number || '?'})</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box info">
                    <div class="metric-value">${data.total_laps}</div>
                    <div class="metric-label">Total Laps</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box">
                    <div class="metric-value">${hotLaps}</div>
                    <div class="metric-label">Hot Laps</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box warning">
                    <div class="metric-value">${formatLapTime(data.average_lap_time)}</div>
                    <div class="metric-label">Average Lap</div>
                </div>
            </div>
        `;

        displayRecommendations(data.recommendations || []);

        // Show lap recommendations if available
        if (data.lap_recommendations) {
            displayLapRecommendations(data.lap_recommendations);
        }

        // Show lap filter section
        document.getElementById('lap-filter-section').style.display = 'block';

        let detailsHtml = `
            <div class="col-md-8 mb-4">
                <div class="card analysis-card laps">
                    <div class="card-header">Lap Times</div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="lap-times-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card analysis-card laps">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Lap Details</span>
                        <small class="text-muted">Select 2 to compare</small>
                    </div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr><th style="width:30px;"></th><th>Lap</th><th>Time</th><th>Delta</th><th>Type</th></tr>
                            </thead>
                            <tbody id="lap-table-body">
        `;

        const bestTime = fastest.lap_time || 0;
        const recommendedLaps = data.lap_recommendations?.recommended_laps || [];

        for (const lap of (data.laps || [])) {
            const delta = lap.lap_time - bestTime;
            const deltaClass = delta === 0 ? 'text-success' : (delta < 2 ? '' : 'text-warning');
            const classification = lap.classification || 'race_pace';
            const isRecommended = recommendedLaps.includes(lap.lap_number);
            const rowClass = isRecommended ? 'table-active' : '';

            detailsHtml += `
                <tr class="${rowClass}" data-classification="${classification}" data-lap="${lap.lap_number}">
                    <td><input type="checkbox" class="lap-checkbox" data-lap="${lap.lap_number}" onchange="updateLapSelection()"></td>
                    <td>${lap.lap_number}${isRecommended ? ' *' : ''}</td>
                    <td>${formatLapTime(lap.lap_time)}</td>
                    <td class="${deltaClass}">${delta === 0 ? 'Best' : '+' + delta.toFixed(2)}</td>
                    <td>${getClassificationBadge(classification)}</td>
                </tr>
            `;
        }

        detailsHtml += `
                            </tbody>
                        </table>
                        <small class="text-muted">* Recommended for analysis</small>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('details-section').innerHTML = detailsHtml;

        setTimeout(() => {
            if (data.laps) {
                renderLapTimesChart(data.laps);
                // Apply initial filters
                applyLapFilters();
            }
        }, 100);
    }

    function displayGearAnalysis(data) {
        document.getElementById('summary-row').innerHTML = `
            <div class="col-md-3 mb-3">
                <div class="metric-box">
                    <div class="metric-value">${data.gears_used || Object.keys(data.gear_usage || {}).length}</div>
                    <div class="metric-label">Gears Used</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box info">
                    <div class="metric-value">${data.most_used_gear || 'N/A'}</div>
                    <div class="metric-label">Most Used Gear</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box success">
                    <div class="metric-value">${data.avg_gear?.toFixed(1) || 'N/A'}</div>
                    <div class="metric-label">Avg Gear</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box warning">
                    <div class="metric-value">${(data.total_time_seconds / 60)?.toFixed(1) || 'N/A'} min</div>
                    <div class="metric-label">Session Time</div>
                </div>
            </div>
        `;

        displayRecommendations(data.recommendations || []);

        let detailsHtml = `
            <div class="col-md-6 mb-4">
                <div class="card analysis-card gears">
                    <div class="card-header">Gear Distribution</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="gear-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card analysis-card gears">
                    <div class="card-header">Gear Statistics</div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr><th>Gear</th><th>Time</th><th>%</th><th>Avg RPM</th></tr>
                            </thead>
                            <tbody>
        `;

        const gearUsage = data.gear_usage || {};
        for (const [gear, stats] of Object.entries(gearUsage)) {
            const pct = stats.time_pct || (stats.time_seconds / data.total_time_seconds * 100);
            detailsHtml += `
                <tr>
                    <td><strong>Gear ${gear}</strong></td>
                    <td>${stats.time_seconds?.toFixed(1) || 'N/A'}s</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" style="width: ${pct}%">${pct.toFixed(1)}%</div>
                        </div>
                    </td>
                    <td>${stats.avg_rpm?.toFixed(0) || 'N/A'}</td>
                </tr>
            `;
        }

        detailsHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('details-section').innerHTML = detailsHtml;

        setTimeout(() => {
            renderGearDistributionChart(gearUsage);
        }, 100);
    }

    function displayPowerAnalysis(data) {
        document.getElementById('summary-row').innerHTML = `
            <div class="col-md-3 mb-3">
                <div class="metric-box success">
                    <div class="metric-value">${data.max_power_hp?.toFixed(0) || 'N/A'} hp</div>
                    <div class="metric-label">Peak Power</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box info">
                    <div class="metric-value">${data.max_acceleration_g?.toFixed(2) || 'N/A'} g</div>
                    <div class="metric-label">Max Accel</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box warning">
                    <div class="metric-value">${data.max_braking_g?.toFixed(2) || 'N/A'} g</div>
                    <div class="metric-label">Max Braking</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-box">
                    <div class="metric-value">${data.avg_power_hp?.toFixed(0) || 'N/A'} hp</div>
                    <div class="metric-label">Avg Power</div>
                </div>
            </div>
        `;

        displayRecommendations(data.recommendations || []);

        let detailsHtml = `
            <div class="col-md-6 mb-4">
                <div class="card analysis-card power">
                    <div class="card-header">Acceleration Events</div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr><th>Time</th><th>Type</th><th>G-Force</th><th>Duration</th></tr>
                            </thead>
                            <tbody>
        `;

        const events = data.events || [];
        for (const event of events.slice(0, 30)) {
            const typeClass = event.type === 'acceleration' ? 'text-success' : 'text-warning';
            detailsHtml += `
                <tr>
                    <td>${event.time?.toFixed(1) || 'N/A'}s</td>
                    <td class="${typeClass}">${event.type}</td>
                    <td>${event.g_force?.toFixed(2) || 'N/A'} g</td>
                    <td>${event.duration?.toFixed(1) || 'N/A'}s</td>
                </tr>
            `;
        }

        detailsHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card analysis-card power">
                    <div class="card-header">Power Summary</div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li class="mb-2"><strong>Vehicle Mass:</strong> ${data.vehicle_mass_kg || 'N/A'} kg</li>
                            <li class="mb-2"><strong>Peak Power RPM:</strong> ${data.peak_power_rpm?.toFixed(0) || 'N/A'} RPM</li>
                            <li class="mb-2"><strong>Accel Events:</strong> ${data.acceleration_event_count || 0}</li>
                            <li class="mb-2"><strong>Braking Events:</strong> ${data.braking_event_count || 0}</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('details-section').innerHTML = detailsHtml;
    }

    function displayRecommendations(recommendations) {
        const section = document.getElementById('recommendations-section');
        const content = document.getElementById('recommendations-content');

        if (!recommendations || recommendations.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        content.innerHTML = recommendations.map(rec =>
            `<div class="recommendation-item">${rec}</div>`
        ).join('');
    }

    // Chart rendering functions
    function renderLapTimesChart(laps) {
        const ctx = document.getElementById('lap-times-chart');
        if (!ctx) return;

        const labels = laps.map(l => `Lap ${l.lap_number}`);
        const times = laps.map(l => l.lap_time);
        const minTime = Math.min(...times);

        charts['lap-times'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Lap Time (s)',
                    data: times,
                    backgroundColor: times.map(t => t === minTime ? '#00b894' : '#4a90e2'),
                    borderColor: times.map(t => t === minTime ? '#00b894' : '#357abd'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: '#404040' },
                        ticks: { color: '#a0a0a0' }
                    },
                    x: {
                        grid: { color: '#404040' },
                        ticks: { color: '#a0a0a0' }
                    }
                }
            }
        });
    }

    function renderShiftRpmChart(gearStats) {
        const ctx = document.getElementById('shift-rpm-chart');
        if (!ctx) return;

        const gears = Object.keys(gearStats).filter(g => gearStats[g].upshift_count > 0).sort();
        const avgRpms = gears.map(g => gearStats[g].avg_upshift_rpm);
        const targetRpms = gears.map(g => gearStats[g].optimal_upshift_rpm);

        charts['shift-rpm'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: gears.map(g => `Gear ${g}`),
                datasets: [
                    {
                        label: 'Avg Shift RPM',
                        data: avgRpms,
                        backgroundColor: '#4a90e2',
                        borderColor: '#357abd',
                        borderWidth: 1
                    },
                    {
                        label: 'Target RPM',
                        data: targetRpms,
                        backgroundColor: 'rgba(0, 184, 148, 0.3)',
                        borderColor: '#00b894',
                        borderWidth: 2,
                        type: 'line',
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#a0a0a0' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 4000,
                        grid: { color: '#404040' },
                        ticks: { color: '#a0a0a0' }
                    },
                    x: {
                        grid: { color: '#404040' },
                        ticks: { color: '#a0a0a0' }
                    }
                }
            }
        });
    }

    function renderGearDistributionChart(gearUsage) {
        const ctx = document.getElementById('gear-distribution-chart');
        if (!ctx) return;

        const gears = Object.keys(gearUsage).sort();
        const times = gears.map(g => gearUsage[g].time_seconds || 0);

        charts['gear-dist'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: gears.map(g => `Gear ${g}`),
                datasets: [{
                    data: times,
                    backgroundColor: ['#e17055', '#fdcb6e', '#00b894', '#00cec9', '#0984e3', '#6c5ce7'],
                    borderColor: '#2d2d2d',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: '#a0a0a0' }
                    }
                }
            }
        });
    }

    // Track map functions
    let currentFile = null;
    let trackMapDebounceTimer = null;

    async function loadTrackMap(filename, colorBy = 'speed') {
        const container = document.getElementById('track-map-container');
        const section = document.getElementById('track-map-section');
        const lowThreshold = document.getElementById('low-threshold').value;
        const highThreshold = document.getElementById('high-threshold').value;

        try {
            container.innerHTML = '<div class="text-muted">Loading track map...</div>';
            const url = `/api/track-map/${encodeURIComponent(filename)}?color_by=${colorBy}&format=svg&discrete=true&low_threshold=${lowThreshold}&high_threshold=${highThreshold}`;
            const response = await fetch(url);
            if (response.ok) {
                container.innerHTML = await response.text();
                section.style.display = 'block';
            } else {
                container.innerHTML = '<div class="text-muted">Track map not available (no GPS data)</div>';
            }
        } catch (e) {
            console.error('Track map error:', e);
            container.innerHTML = '<div class="text-muted">Failed to load track map</div>';
        }
    }

    // Debounced track map reload for sliders
    function reloadTrackMapDebounced() {
        if (trackMapDebounceTimer) clearTimeout(trackMapDebounceTimer);
        trackMapDebounceTimer = setTimeout(() => {
            if (currentFile) {
                loadTrackMap(currentFile, document.getElementById('track-map-color').value);
            }
        }, 300);
    }

    // Initialize track map color selector
    document.getElementById('track-map-color').addEventListener('change', function() {
        if (currentFile) {
            loadTrackMap(currentFile, this.value);
        }
    });

    // Initialize threshold sliders
    document.getElementById('low-threshold').addEventListener('input', function() {
        document.getElementById('low-threshold-value').textContent = this.value + '%';
        // Ensure low < high
        const highSlider = document.getElementById('high-threshold');
        if (parseInt(this.value) >= parseInt(highSlider.value)) {
            highSlider.value = parseInt(this.value) + 10;
            document.getElementById('high-threshold-value').textContent = highSlider.value + '%';
        }
        reloadTrackMapDebounced();
    });

    document.getElementById('high-threshold').addEventListener('input', function() {
        document.getElementById('high-threshold-value').textContent = this.value + '%';
        // Ensure high > low
        const lowSlider = document.getElementById('low-threshold');
        if (parseInt(this.value) <= parseInt(lowSlider.value)) {
            lowSlider.value = parseInt(this.value) - 10;
            document.getElementById('low-threshold-value').textContent = lowSlider.value + '%';
        }
        reloadTrackMapDebounced();
    });

    // Lap classification badge helper
    function getClassificationBadge(classification) {
        const badges = {
            'hot_lap': '<span class="badge badge-hot-lap">Hot</span>',
            'race_pace': '<span class="badge badge-race-pace">Race</span>',
            'warm_up': '<span class="badge badge-warm-up">Warm-up</span>',
            'cool_down': '<span class="badge badge-cool-down">Cool-down</span>',
            'out_lap': '<span class="badge badge-out-lap">Out</span>',
            'incomplete': '<span class="badge bg-dark">Incomplete</span>'
        };
        return badges[classification] || '';
    }

    // Display lap recommendations
    function displayLapRecommendations(recommendations) {
        const panel = document.getElementById('lap-recommendations');
        if (!recommendations) {
            panel.style.display = 'none';
            return;
        }

        const lapsSpan = document.getElementById('recommended-laps');
        const reasonSpan = document.getElementById('recommendation-reason');

        lapsSpan.innerHTML = recommendations.recommended_laps
            .map(lap => `<span class="recommended-lap-badge">Lap ${lap}</span>`)
            .join(' ');
        reasonSpan.textContent = recommendations.reason;
        panel.style.display = 'block';
    }

    // Lap filtering
    function setupLapFilters() {
        const filterCheckboxes = ['filter-hot', 'filter-race', 'filter-warmup', 'filter-cooldown', 'filter-outlap'];
        filterCheckboxes.forEach(id => {
            document.getElementById(id).addEventListener('change', applyLapFilters);
        });
    }

    function applyLapFilters() {
        const showHot = document.getElementById('filter-hot').checked;
        const showRace = document.getElementById('filter-race').checked;
        const showWarmup = document.getElementById('filter-warmup').checked;
        const showCooldown = document.getElementById('filter-cooldown').checked;
        const showOutlap = document.getElementById('filter-outlap').checked;

        const classificationMap = {
            'hot_lap': showHot,
            'race_pace': showRace,
            'warm_up': showWarmup,
            'cool_down': showCooldown,
            'out_lap': showOutlap
        };

        // Filter table rows
        document.querySelectorAll('#lap-table-body tr').forEach(row => {
            const classification = row.dataset.classification;
            if (classificationMap[classification]) {
                row.classList.remove('lap-hidden');
            } else {
                row.classList.add('lap-hidden');
            }
        });

        // Update chart with filtered data
        updateLapChartWithFilters(classificationMap);
    }

    function updateLapChartWithFilters(classificationMap) {
        if (!currentData || !currentData.laps || !charts['lap-times']) return;

        const filteredLaps = currentData.laps.filter(lap => classificationMap[lap.classification]);
        const labels = filteredLaps.map(l => `Lap ${l.lap_number}`);
        const times = filteredLaps.map(l => l.lap_time);
        const minTime = times.length > 0 ? Math.min(...times) : 0;

        charts['lap-times'].data.labels = labels;
        charts['lap-times'].data.datasets[0].data = times;
        charts['lap-times'].data.datasets[0].backgroundColor = times.map(t => t === minTime ? '#00b894' : '#4a90e2');
        charts['lap-times'].data.datasets[0].borderColor = times.map(t => t === minTime ? '#00b894' : '#357abd');
        charts['lap-times'].update();
    }

    // Initialize filters on page load
    document.addEventListener('DOMContentLoaded', setupLapFilters);

    // Lap selection for comparison
    let selectedLaps = [];

    function updateLapSelection() {
        selectedLaps = [];
        document.querySelectorAll('.lap-checkbox:checked').forEach(cb => {
            selectedLaps.push(parseInt(cb.dataset.lap));
        });

        // Update row highlighting
        document.querySelectorAll('#lap-table-body tr').forEach(row => {
            const lapNum = parseInt(row.dataset.lap);
            if (selectedLaps.includes(lapNum)) {
                row.classList.add('lap-selected');
            } else {
                row.classList.remove('lap-selected');
            }
        });

        // Show/hide compare button
        const compareBtn = document.getElementById('compare-laps-btn');
        const countSpan = document.getElementById('selected-count');
        countSpan.textContent = selectedLaps.length;

        if (selectedLaps.length === 2) {
            compareBtn.style.display = 'inline-block';
            compareBtn.classList.remove('btn-secondary');
            compareBtn.classList.add('btn-success');
        } else if (selectedLaps.length > 0) {
            compareBtn.style.display = 'inline-block';
            compareBtn.classList.remove('btn-success');
            compareBtn.classList.add('btn-secondary');
        } else {
            compareBtn.style.display = 'none';
        }
    }

    async function compareLaps() {
        if (selectedLaps.length !== 2) {
            showAlert('Please select exactly 2 laps to compare', 'warning');
            return;
        }

        const lapA = Math.min(...selectedLaps);
        const lapB = Math.max(...selectedLaps);

        document.getElementById('loading').style.display = 'flex';

        try {
            const url = `/api/analyze/laps/compare/${encodeURIComponent(currentFile)}?lap_a=${lapA}&lap_b=${lapB}`;
            const response = await fetch(url);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Comparison failed');
            }

            const data = await response.json();
            displayComparison(data);

        } catch (error) {
            showAlert('Lap comparison failed: ' + error.message, 'danger');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function displayComparison(data) {
        const section = document.getElementById('lap-comparison-section');
        section.style.display = 'block';

        // Scroll to comparison
        section.scrollIntoView({ behavior: 'smooth' });

        // Update title
        document.getElementById('comparison-title').textContent = `Lap ${data.lap_a} vs Lap ${data.lap_b}`;

        // Update lap cards
        document.getElementById('comp-lap-a-label').textContent = `Lap ${data.lap_a}`;
        document.getElementById('comp-lap-b-label').textContent = `Lap ${data.lap_b}`;
        document.getElementById('comp-lap-a-time').textContent = formatLapTime(data.summary.lap_a_time);
        document.getElementById('comp-lap-b-time').textContent = formatLapTime(data.summary.lap_b_time);
        document.getElementById('comp-lap-a-avg').textContent = data.summary.lap_a_avg_speed;
        document.getElementById('comp-lap-b-avg').textContent = data.summary.lap_b_avg_speed;
        document.getElementById('comp-lap-a-max').textContent = data.summary.lap_a_max_speed;
        document.getElementById('comp-lap-b-max').textContent = data.summary.lap_b_max_speed;

        // Delta summary
        const deltaEl = document.getElementById('comp-delta-summary');
        const delta = data.time_delta;
        if (delta > 0) {
            deltaEl.className = 'h4 delta-positive';
            deltaEl.textContent = `Lap ${data.lap_a} faster by ${delta.toFixed(2)}s`;
        } else if (delta < 0) {
            deltaEl.className = 'h4 delta-negative';
            deltaEl.textContent = `Lap ${data.lap_b} faster by ${Math.abs(delta).toFixed(2)}s`;
        } else {
            deltaEl.className = 'h4 delta-neutral';
            deltaEl.textContent = 'Laps are equal';
        }

        // Speed delta chart
        renderSpeedDeltaChart(data.speed_deltas, data.lap_a, data.lap_b);

        // Segment bars
        renderSegmentBars(data.segments, data.lap_a, data.lap_b);

        // Delta track map
        loadDeltaTrackMap(data.lap_a, data.lap_b);
    }

    async function loadDeltaTrackMap(lapA, lapB) {
        const container = document.getElementById('delta-track-map-container');
        container.innerHTML = '<div class="text-muted">Loading delta track map...</div>';

        try {
            const url = `/api/track-map/delta/${encodeURIComponent(currentFile)}?lap_a=${lapA}&lap_b=${lapB}&segments=20`;
            const response = await fetch(url);

            if (response.ok) {
                container.innerHTML = await response.text();
                // Scale SVG to fit container
                const svg = container.querySelector('svg');
                if (svg) {
                    svg.style.maxWidth = '100%';
                    svg.style.height = 'auto';
                }
            } else {
                const error = await response.json();
                container.innerHTML = `<div class="text-warning">Delta map not available: ${error.detail || 'Unknown error'}</div>`;
            }
        } catch (e) {
            console.error('Delta track map error:', e);
            container.innerHTML = '<div class="text-warning">Failed to load delta track map</div>';
        }
    }

    function renderSpeedDeltaChart(speedDeltas, lapA, lapB) {
        const ctx = document.getElementById('speed-delta-chart');
        if (!ctx) return;

        // Destroy existing chart
        if (charts['speed-delta']) {
            charts['speed-delta'].destroy();
        }

        const labels = speedDeltas.map(d => d.distance_pct + '%');
        const deltas = speedDeltas.map(d => d.delta);

        charts['speed-delta'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Speed Delta (Lap ${lapA} - Lap ${lapB})`,
                    data: deltas,
                    borderColor: deltas.map(d => d >= 0 ? '#00b894' : '#e74c3c'),
                    backgroundColor: 'transparent',
                    segment: {
                        borderColor: ctx2 => {
                            const val = ctx2.p1.parsed.y;
                            return val >= 0 ? '#00b894' : '#e74c3c';
                        }
                    },
                    tension: 0.3,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const val = ctx.raw;
                                return val >= 0 ? `+${val.toFixed(1)} mph (Lap ${lapA} faster)` : `${val.toFixed(1)} mph (Lap ${lapB} faster)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        grid: { color: '#404040' },
                        ticks: { color: '#a0a0a0' },
                        title: { display: true, text: 'Speed Î” (mph)', color: '#a0a0a0' }
                    },
                    x: {
                        grid: { color: '#404040' },
                        ticks: { color: '#a0a0a0', maxTicksLimit: 10 },
                        title: { display: true, text: 'Distance %', color: '#a0a0a0' }
                    }
                }
            }
        });
    }

    function renderSegmentBars(segments, lapA, lapB) {
        const container = document.getElementById('segment-bars');
        let html = '';

        for (const seg of segments) {
            let barClass, label;
            if (seg.faster === 'A') {
                barClass = 'segment-a';
                label = `+${seg.time_delta.toFixed(2)}s`;
            } else if (seg.faster === 'B') {
                barClass = 'segment-b';
                label = `${seg.time_delta.toFixed(2)}s`;
            } else {
                barClass = 'segment-equal';
                label = '=';
            }

            html += `
                <div class="d-flex align-items-center mb-1">
                    <small class="text-muted me-2" style="width: 40px;">S${seg.segment}</small>
                    <div class="flex-grow-1 segment-bar ${barClass}">${label}</div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    function hideComparison() {
        document.getElementById('lap-comparison-section').style.display = 'none';
    }
</script>
{% endblock %}
