{% extends "base.html" %}

{% block title %}Session Data Viewer - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Session Data Viewer</h1>
        <p class="text-muted">Browse extracted telemetry data (Parquet files)</p>
    </div>
</div>

<!-- File List -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Available Sessions</span>
                <button class="btn btn-sm btn-outline-primary" onclick="loadFileList()">Refresh</button>
            </div>
            <div class="card-body">
                <div id="file-list">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Summary -->
<div class="row mb-4" id="summary-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <span id="summary-title">Session Summary</span>
            </div>
            <div class="card-body">
                <div class="row" id="summary-stats">
                    <!-- Filled by JS -->
                </div>
                <hr>
                <h6>Channel Overview</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Min</th>
                                <th>Max</th>
                                <th>Mean</th>
                                <th>Valid %</th>
                            </tr>
                        </thead>
                        <tbody id="channel-stats">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="row" id="data-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Raw Data</span>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="prevPage()">Prev</button>
                    <span id="page-info" class="mx-2">0-0 of 0</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="nextPage()">Next</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                    <table class="table table-sm table-striped">
                        <thead id="data-header">
                            <!-- Filled by JS -->
                        </thead>
                        <tbody id="data-body">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentFile = null;
    let currentOffset = 0;
    const pageSize = 100;
    let totalRows = 0;

    async function loadFileList() {
        try {
            const response = await fetch('/api/parquet/list');
            const data = await response.json();

            const container = document.getElementById('file-list');

            if (data.parquet_files.length === 0) {
                container.innerHTML = '<div class="text-muted">No Parquet files found. Extract sessions on Windows first.</div>';
                return;
            }

            let html = '<div class="list-group">';
            for (const file of data.parquet_files) {
                if (file.error) {
                    html += `<div class="list-group-item list-group-item-danger">${file.filename}: ${file.error}</div>`;
                } else {
                    html += `
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                           onclick="loadFile('${file.path}'); return false;"
                           style="background-color: #353535; border-color: #404040;">
                            <div>
                                <strong>${file.filename}</strong>
                                <small class="text-muted d-block">${file.source}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-info">${file.rows.toLocaleString()} rows</span>
                                <span class="badge bg-secondary">${file.columns} channels</span>
                                <span class="badge bg-dark">${file.size_mb} MB</span>
                            </div>
                        </a>
                    `;
                }
            }
            html += '</div>';
            container.innerHTML = html;

        } catch (error) {
            document.getElementById('file-list').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    async function loadFile(path) {
        currentFile = path;
        currentOffset = 0;

        // Load summary
        try {
            const summaryRes = await fetch(`/api/parquet/summary/${encodeURIComponent(path)}`);
            const summary = await summaryRes.json();

            document.getElementById('summary-title').textContent = `Session: ${summary.filename}`;

            document.getElementById('summary-stats').innerHTML = `
                <div class="col-md-3">
                    <div class="stat-card p-3 text-center">
                        <h3>${summary.rows.toLocaleString()}</h3>
                        <small>Samples</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card p-3 text-center">
                        <h3>${summary.columns}</h3>
                        <small>Channels</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card p-3 text-center">
                        <h3>${(summary.duration_seconds / 60).toFixed(1)}</h3>
                        <small>Minutes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card p-3 text-center">
                        <h3>${summary.sample_rate_hz}</h3>
                        <small>Hz</small>
                    </div>
                </div>
            `;

            let channelHtml = '';
            for (const [name, stats] of Object.entries(summary.channels)) {
                channelHtml += `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td>${stats.min !== undefined ? stats.min.toFixed(2) : '-'}</td>
                        <td>${stats.max !== undefined ? stats.max.toFixed(2) : '-'}</td>
                        <td>${stats.mean !== undefined ? stats.mean.toFixed(2) : '-'}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: ${stats.valid_pct}%">${stats.valid_pct}%</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('channel-stats').innerHTML = channelHtml;

            document.getElementById('summary-section').style.display = 'block';

            totalRows = summary.rows;

        } catch (error) {
            alert('Failed to load summary: ' + error.message);
            return;
        }

        // Load data
        await loadData();
        document.getElementById('data-section').style.display = 'block';
    }

    async function loadData() {
        if (!currentFile) return;

        try {
            const response = await fetch(`/api/parquet/view/${encodeURIComponent(currentFile)}?offset=${currentOffset}&limit=${pageSize}`);
            const data = await response.json();

            // Header
            let headerHtml = '<tr><th>Time (s)</th>';
            for (const col of data.columns.slice(0, 10)) {  // Limit columns for readability
                headerHtml += `<th>${col}</th>`;
            }
            if (data.columns.length > 10) {
                headerHtml += `<th>... +${data.columns.length - 10} more</th>`;
            }
            headerHtml += '</tr>';
            document.getElementById('data-header').innerHTML = headerHtml;

            // Body
            let bodyHtml = '';
            for (const row of data.data) {
                bodyHtml += '<tr>';
                // Use actual time from index (now included in response)
                const time = row.Time !== undefined ? row.Time : 0;
                bodyHtml += `<td>${time.toFixed(2)}</td>`;

                for (const col of data.columns.slice(0, 10)) {
                    const val = row[col];
                    if (val === "NaN" || val === null) {
                        bodyHtml += '<td class="text-muted">-</td>';
                    } else if (typeof val === 'number') {
                        bodyHtml += `<td>${val.toFixed(2)}</td>`;
                    } else {
                        bodyHtml += `<td>${val}</td>`;
                    }
                }
                if (data.columns.length > 10) {
                    bodyHtml += '<td>...</td>';
                }
                bodyHtml += '</tr>';
            }
            document.getElementById('data-body').innerHTML = bodyHtml;

            // Page info
            const endRow = Math.min(currentOffset + pageSize, data.total_rows);
            document.getElementById('page-info').textContent = `${currentOffset + 1}-${endRow} of ${data.total_rows.toLocaleString()}`;

        } catch (error) {
            document.getElementById('data-body').innerHTML = `<tr><td colspan="10" class="text-danger">Error: ${error.message}</td></tr>`;
        }
    }

    function prevPage() {
        if (currentOffset >= pageSize) {
            currentOffset -= pageSize;
            loadData();
        }
    }

    function nextPage() {
        if (currentOffset + pageSize < totalRows) {
            currentOffset += pageSize;
            loadData();
        }
    }

    // Load file list on page load
    loadFileList();
</script>
{% endblock %}
