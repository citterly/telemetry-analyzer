{% extends "base.html" %}

{% block title %}Track Map - {{ super() }}{% endblock %}

{% block content %}
{% include "components/session_selector.html" %}

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Track Map</h1>
        <p class="text-muted">GPS track visualization colored by telemetry data</p>
    </div>
</div>

<!-- Controls -->
<div class="row mb-3">
    <div class="col-md-4">
        <div class="control-panel">
            <label for="colorBy" class="form-label">Color by</label>
            <select id="colorBy" class="form-select" onchange="reloadMap()">
                <option value="speed" selected>Speed</option>
                <option value="rpm">RPM</option>
                <option value="gear">Gear</option>
                <option value="throttle">Throttle</option>
            </select>
        </div>
    </div>
</div>

<!-- Map Display -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <span id="map-title">Track Map</span>
            </div>
            <div class="card-body">
                <div id="mapContainer" style="min-height: 400px;">
                    <div class="text-center text-muted py-5">Select a session to view track map</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentParquetPath = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
        if (window._sessionSelector._initPromise) {
            await window._sessionSelector._initPromise;
        }

        window._sessionSelector.onContextChange = async function(context) {
            await loadSessionForMap(context.active_session_id);
        };

        const context = window._sessionSelector.currentContext;
        if (context && context.active_session_id) {
            await loadSessionForMap(context.active_session_id);
        }
    });

    async function loadSessionForMap(sessionId) {
        try {
            const response = await apiCall(`/api/v2/sessions/${sessionId}`);
            const session = response.session;

            if (!session || !session.parquet_path) {
                showAlert('Session has no parquet data', 'warning');
                return;
            }

            currentParquetPath = session.parquet_path;
            await reloadMap();
        } catch (error) {
            showAlert(`Failed to load session: ${error.message}`, 'danger');
        }
    }

    async function reloadMap() {
        if (!currentParquetPath) return;

        const container = document.getElementById('mapContainer');
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading track map...</p></div>';

        const colorBy = document.getElementById('colorBy').value;

        try {
            const response = await fetch(`/api/track-map/${encodeURIComponent(currentParquetPath)}?color_by=${colorBy}&format=svg`);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to load track map');
            }

            const svgContent = await response.text();
            container.innerHTML = svgContent;

            // Make SVG responsive
            const svg = container.querySelector('svg');
            if (svg) {
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxHeight = '600px';
            }

            document.getElementById('map-title').textContent = `Track Map (colored by ${colorBy})`;
        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">Failed to load track map: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}
